<template>
  <multiselect
    v-model="selections"
    label="name"
    track-by="_id"
    placeholder
    open-direction="bottom"
    :options="options"
    :searchable="true"
    :loading="loading"
    :multiple="isMultiple"
    :internal-search="false"
    :close-on-select="isMultiple ? false : true"
    :options-limit="3000"
    :option-height="20"
    :max-height="600"
    class="v-multiselect el-select"
    :class="{
      'is-single': !isMultiple ? true : false,
      'no-options': !options.length,
      'has-one-option-selected': isMultiple && selections.length === 1,
      'has-more-than-one-option': isMultiple && selections.length > 1
    }"
    style="top: -.2rem; height: 40px;"
    @search-change="$emit('input', $event)"
    @open="() => (isDropdownOpen = true)"
    @close="handleClose"
    @remove="handleRemovedItem"
  >
    <!-- @select="handleSelectItem" -->
    <template slot="tag" slot-scope="{ option, remove }">
      <div
        class="counter relative"
        :data-selected-length="selections.length - 1"
      >
        <div
          class="el-tag el-tag--info el-tag--small el-tag--light relative truncate"
        >
          <span
            class="el-select__tags-text inline-block"
            style="max-width: 4.2rem;"
            :title="option.name"
          >
            {{ option.name }}
          </span>
          <i
            class="el-tag__close el-icon-close"
            style="top: 5px; right: 0; position: absolute;"
            :title="`remove ${option.name}`"
            @click="remove(option)"
          />
        </div>
      </div>
    </template>
    <template slot="caret" slot-scope="{ toggle }">
      <span class="el-input__suffix">
        <span class="el-input__suffix-inner" @click="toggle" @focus="toggle">
          <i
            class="el-select__caret el-input__icon el-icon-arrow-up caret"
            :class="{
              'is-reverse': isDropdownOpen
            }"
          />
        </span>
      </span>
    </template>
    <p class="el-select-dropdown__empty" slot="noResult">No data</p>
    <p class="el-select-dropdown__empty" slot="noOptions">No data</p>
  </multiselect>
</template>

<script>
import Multiselect from 'vue-multiselect'
import 'vue-multiselect/dist/vue-multiselect.min.css'

export default {
  name: 'VMultiselect',
  components: {
    Multiselect
  },
  props: {
    value: {
      type: [Array, String],
      default: () => []
    },
    options: {
      type: Array,
      required: true
    },
    loading: {
      type: Boolean,
      required: true
    },
    isMultiple: {
      type: Boolean,
      default: () => true
    },
    mode: {
      type: String,
      default: () => 'create'
    }
  },
  data: () => ({
    isDropdownOpen: false,
    selections: []
  }),
  mounted() {
    if (this.mode !== 'create') {
      this.selections = this.value
    }
  },
  methods: {
    handleClose() {
      this.isDropdownOpen = false
      return this.$emit('values-change', this.selections)
    },
    handleRemovedItem(removed) {
      return this.$emit('remove', removed._id)
    }
  }
}
</script>

<style lang="scss" scoped>
@import '../assets/scss/components/multiselect-styles.scss';
</style>
